package dbp.client;

import java.awt.BorderLayout;
import java.awt.Dimension;
import java.awt.EventQueue;
import java.awt.Font;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Rectangle;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.math.BigDecimal;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import javax.swing.DefaultListModel;
import javax.swing.JButton;
import javax.swing.JFormattedTextField;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JRadioButton;
import javax.swing.JScrollPane;
import javax.swing.JTabbedPane;
import javax.swing.JTextArea;
import javax.swing.JTextField;
import javax.swing.ListSelectionModel;
import javax.swing.SwingConstants;
import javax.swing.text.Document;
import com.jgoodies.forms.factories.FormFactory;
import com.jgoodies.forms.layout.ColumnSpec;
import com.jgoodies.forms.layout.FormLayout;
import com.jgoodies.forms.layout.RowSpec;
import dbp.common.Constants;
import dbp.server.DBPFD;
import dbp.server.Player;

public class DBPFDPanel extends DBPPanel {

  private FilteredComboBox<String> pg1ComboBox;
  private FilteredComboBox<String> pg2ComboBox;
  private FilteredComboBox<String> sg1ComboBox;
  private FilteredComboBox<String> sg2ComboBox;
  private FilteredComboBox<String> sf1ComboBox;
  private FilteredComboBox<String> sf2ComboBox;
  private FilteredComboBox<String> pf1ComboBox;
  private FilteredComboBox<String> pf2ComboBox;
  private FilteredComboBox<String> cComboBox;
  private JList<String> excludedPlayerList;
  private DefaultListModel<String> excludedPlayerListModel;

  private DBPFD dbpfd;

  /**
   * Launch the application.
   */
  public static void main(String[] args) {
    EventQueue.invokeLater(new Runnable() {
      public void run() {
        try {
          DBPFDPanel window = new DBPFDPanel();
          window.frame.setVisible(true);
        }
        catch(Exception e) {
          e.printStackTrace();
        }
      }
    });
  }

  /**
   * Initialize the contents of the frame.
   */
  @Override
  protected void initialize() {
    frame = new JFrame();
    frame.setTitle("Daily Basketball Projector");
    frame.setSize(640, 500);
    frame.setLocationRelativeTo(null);
    frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
    glassPane = new DisabledGlassPane();
    frame.setGlassPane(glassPane);
    frame.getContentPane().setLayout(
        new FormLayout(new ColumnSpec[] {FormFactory.RELATED_GAP_COLSPEC, FormFactory.DEFAULT_COLSPEC, FormFactory.RELATED_GAP_COLSPEC,
                                         ColumnSpec.decode("left:default"), ColumnSpec.decode("8dlu"), FormFactory.DEFAULT_COLSPEC,
                                         FormFactory.RELATED_GAP_COLSPEC, ColumnSpec.decode("default:grow"),
                                         FormFactory.RELATED_GAP_COLSPEC, FormFactory.DEFAULT_COLSPEC,},
            new RowSpec[] {FormFactory.RELATED_GAP_ROWSPEC, FormFactory.DEFAULT_ROWSPEC, FormFactory.RELATED_GAP_ROWSPEC,
                           FormFactory.DEFAULT_ROWSPEC, FormFactory.RELATED_GAP_ROWSPEC, FormFactory.DEFAULT_ROWSPEC,
                           FormFactory.RELATED_GAP_ROWSPEC, FormFactory.DEFAULT_ROWSPEC, FormFactory.RELATED_GAP_ROWSPEC,
                           FormFactory.DEFAULT_ROWSPEC, FormFactory.RELATED_GAP_ROWSPEC, FormFactory.DEFAULT_ROWSPEC,
                           FormFactory.RELATED_GAP_ROWSPEC, FormFactory.DEFAULT_ROWSPEC, FormFactory.RELATED_GAP_ROWSPEC,
                           FormFactory.DEFAULT_ROWSPEC, FormFactory.RELATED_GAP_ROWSPEC, FormFactory.DEFAULT_ROWSPEC,
                           FormFactory.RELATED_GAP_ROWSPEC, FormFactory.DEFAULT_ROWSPEC, FormFactory.RELATED_GAP_ROWSPEC,
                           FormFactory.DEFAULT_ROWSPEC, FormFactory.RELATED_GAP_ROWSPEC, FormFactory.DEFAULT_ROWSPEC,
                           FormFactory.RELATED_GAP_ROWSPEC, FormFactory.DEFAULT_ROWSPEC, FormFactory.RELATED_GAP_ROWSPEC,
                           FormFactory.DEFAULT_ROWSPEC, FormFactory.RELATED_GAP_ROWSPEC, FormFactory.DEFAULT_ROWSPEC,
                           FormFactory.RELATED_GAP_ROWSPEC, FormFactory.DEFAULT_ROWSPEC,}));

    JLabel lblPg = new JLabel("PG:");
    frame.getContentPane().add(lblPg, "2, 2, right, default");

    pg1ComboBox = new FilteredComboBox<String>();
    frame.getContentPane().add(pg1ComboBox, "4, 2, fill, default");

    JLabel label = new JLabel("PG:");
    frame.getContentPane().add(label, "2, 4, right, default");

    pg2ComboBox = new FilteredComboBox<String>();
    frame.getContentPane().add(pg2ComboBox, "4, 4, fill, default");

    JLabel lblSg = new JLabel("SG:");
    frame.getContentPane().add(lblSg, "2, 6, right, default");

    sg1ComboBox = new FilteredComboBox<String>();
    frame.getContentPane().add(sg1ComboBox, "4, 6, fill, default");

    JLabel lblSg2 = new JLabel("SG:");
    frame.getContentPane().add(lblSg2, "2, 8, right, default");

    sg2ComboBox = new FilteredComboBox<String>();
    frame.getContentPane().add(sg2ComboBox, "4, 8, fill, default");

    useTotalValueButton = new JRadioButton("Use Total Value");
    useTotalValueButton.setHorizontalAlignment(SwingConstants.RIGHT);
    useTotalValueButton.setHorizontalTextPosition(SwingConstants.LEFT);
    useTotalValueButton.setSelected(true);
    buttonGroup.add(useTotalValueButton);
    frame.getContentPane().add(useTotalValueButton, "6, 8");

    JLabel lblSf = new JLabel("SF:");
    frame.getContentPane().add(lblSf, "2, 10, right, default");

    sf1ComboBox = new FilteredComboBox<String>();
    frame.getContentPane().add(sf1ComboBox, "4, 10, fill, default");

    useTotalCompButton = new JRadioButton("Use Total Comp Value");
    useTotalCompButton.setHorizontalAlignment(SwingConstants.RIGHT);
    useTotalCompButton.setHorizontalTextPosition(SwingConstants.LEFT);
    buttonGroup.add(useTotalCompButton);
    frame.getContentPane().add(useTotalCompButton, "6, 10");

    JLabel label_2 = new JLabel("SF:");
    frame.getContentPane().add(label_2, "2, 12, right, default");

    sf2ComboBox = new FilteredComboBox<String>();
    frame.getContentPane().add(sf2ComboBox, "4, 12, fill, default");

    useTotalAverageButton = new JRadioButton("Use Total Average");
    useTotalAverageButton.setHorizontalAlignment(SwingConstants.RIGHT);
    useTotalAverageButton.setHorizontalTextPosition(SwingConstants.LEFT);
// useTotalAverageButton.setSelected(true);

    buttonGroup.add(useTotalAverageButton);
    frame.getContentPane().add(useTotalAverageButton, "6, 12");

    JLabel lblPf = new JLabel("PF:");
    frame.getContentPane().add(lblPf, "2, 14, right, default");

    pf1ComboBox = new FilteredComboBox<String>();
    frame.getContentPane().add(pf1ComboBox, "4, 14, fill, default");

    JLabel label_3 = new JLabel("PF:");
    frame.getContentPane().add(label_3, "2, 16, right, default");

    pf2ComboBox = new FilteredComboBox<String>();
    frame.getContentPane().add(pf2ComboBox, "4, 16, fill, default");

    JLabel lblC = new JLabel("C:");
    frame.getContentPane().add(lblC, "2, 18, right, default");

    cComboBox = new FilteredComboBox<String>();
    frame.getContentPane().add(cComboBox, "4, 18, fill, default");

    JLabel lblMinRatioPer = new JLabel("Minimum Ratio Per Player:");
    frame.getContentPane().add(lblMinRatioPer, "6, 2, right, default");

    NumberFormat ratioFormat = NumberFormat.getNumberInstance();
    ratioFormat.setMaximumIntegerDigits(2);
    ratioFormat.setMinimumIntegerDigits(1);
    ratioFormat.setMaximumFractionDigits(2);
    ratioFormat.setMinimumFractionDigits(2);

    minRatioField = new JFormattedTextField(ratioFormat);
    minRatioField.setValue(Constants.FD_RATIO_THRESHOLD);
    minRatioField.setColumns(5);
    frame.getContentPane().add(minRatioField, "8, 2, left, default");

    JLabel lblMinimumValuePer = new JLabel("Minimum Value Per Player:");
    frame.getContentPane().add(lblMinimumValuePer, "6, 4, right, default");

    NumberFormat valueFormat = NumberFormat.getNumberInstance();
    valueFormat.setMaximumIntegerDigits(2);
    valueFormat.setMinimumIntegerDigits(1);
    valueFormat.setMaximumFractionDigits(2);
    valueFormat.setMinimumFractionDigits(2);

    minValueField = new JFormattedTextField(valueFormat);
    minValueField.setValue(Constants.FD_VALUE_THRESHOLD);
    minValueField.setColumns(5);
    frame.getContentPane().add(minValueField, "8, 4, left, default");

    excludedPlayerList = new JList<String>();
    excludedPlayerList.setSelectionMode(ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);
    excludedPlayerList.setVisibleRowCount(-1);

    excludedPlayerListModel = new DefaultListModel<String>();
    excludedPlayerList.setModel(excludedPlayerListModel);

    JScrollPane excludedPlayerListScroller = new JScrollPane(excludedPlayerList);
    excludedPlayerListScroller.setPreferredSize(new Dimension(200, 80));

    JLabel excludedPlayerLabel = new JLabel("Exclude Players:");
    frame.getContentPane().add(excludedPlayerLabel, "2, 24, right, default");
    frame.getContentPane().add(excludedPlayerListScroller, "4, 24, fill, default");

    JButton btnUpdateProjections = new JButton("Update Projections");
    btnUpdateProjections.addActionListener(new ActionListener() {
      public void actionPerformed(ActionEvent e) {
        updateProjectionsAndFillComboBoxes();
      };
    });
    frame.getContentPane().add(btnUpdateProjections, "4, 32");

    JButton btnCreateTeams = new JButton("Create Teams");
    btnCreateTeams.addActionListener(new ActionListener() {
      public void actionPerformed(ActionEvent arg0) {
        createTeams();
      }
    });
    frame.getContentPane().add(btnCreateTeams, "6, 32");
// frame.getGlassPane().setVisible(true);
  }

  void addPlayersToComboBox(FilteredComboBox<String> comboBox1, FilteredComboBox<String> comboBox2, List<Player> playerList) {
    comboBox1.removeAllItems();
    comboBox1.addItem("");
    if(comboBox2 != null) {
      comboBox2.removeAllItems();
      comboBox2.addItem("");
    }

    Collections.sort(playerList, Player.getComparator('V'));
    for(Player player : playerList) {
      comboBox1.addItem(player.getName());
      if(comboBox2 != null) {
        comboBox2.addItem(player.getName());
      }
    }
  }

  void addElementsToList(JList<String> list, List<Player> playerList) {
    ((DefaultListModel<String>)list.getModel()).removeAllElements();
    Collections.sort(playerList);
    for(Player player : playerList) {
      ((DefaultListModel<String>)list.getModel()).addElement(player.getName());
    }
  }

  List<String> getReqPlayers(FilteredComboBox<String> comboBox1, FilteredComboBox<String> comboBox2) {
    List<String> reqPlayers = new ArrayList<String>();
    if(!((String)comboBox1.getSelectedItem()).trim().isEmpty()) {
      reqPlayers.add(((String)comboBox1.getSelectedItem()));
    }
    if(comboBox2 != null && !((String)comboBox2.getSelectedItem()).trim().isEmpty()) {
      reqPlayers.add(((String)comboBox2.getSelectedItem()));
    }
    return reqPlayers;
  }

  @Override
  protected void createTeams() {
    final JFrame teamsFrame = new JFrame("Teams By "
        + (useTotalValueButton.isSelected() ? "Total Value" : useTotalCompButton.isSelected() ? "Total Comp Value" : "Total Average"));
    final DisabledGlassPane teamsGlassPane = new DisabledGlassPane();
    teamsFrame.setGlassPane(teamsGlassPane);
    teamsFrame.getContentPane().setLayout(new BorderLayout());
    teamsFrame.setSize(640, 500);
    teamsFrame.setLocationRelativeTo(getFrame());

    final JTextArea teamTextArea = new JTextArea();
    teamTextArea.setFont(new Font("Consolas", Font.PLAIN, 11));
    teamTextArea.setEditable(false);
    JScrollPane teamsScrollPane = new JScrollPane(teamTextArea, JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED,
        JScrollPane.HORIZONTAL_SCROLLBAR_NEVER);
    teamsFrame.getContentPane().add(teamsScrollPane, BorderLayout.CENTER);

    final JTextField findField = new JTextField(20);
    JButton findButton = new JButton("Find");

    JPanel header = new JPanel(new GridBagLayout());

    GridBagConstraints gbc = new GridBagConstraints();
    gbc.gridx = 0;
    gbc.gridy = 0;
    gbc.anchor = GridBagConstraints.WEST;
    header.add(findField, gbc);
    gbc.gridx++;
    header.add(findButton, gbc);
    teamsFrame.getContentPane().add(header, BorderLayout.NORTH);

    findButton.addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent e) {

        // Get the text to find...convert it to lower case for eaiser comparision
        String find = findField.getText().toLowerCase();
        // Focus the text area, otherwise the highlighting won't show up
        teamTextArea.requestFocusInWindow();
        // Make sure we have a valid search term
        if(find != null && find.length() > 0) {
          Document document = teamTextArea.getDocument();
          int findLength = find.length();
          try {
            boolean found = false;
            // Reset the search position if we're at the end of the document
            if(pos + findLength > document.getLength()) {
              pos = 0;
            }
            // While we haven't reached the end...
            // "<=" Correction
            while(pos + findLength <= document.getLength()) {
              // Extract the text from teh docuemnt
              String match = document.getText(pos, findLength).toLowerCase();
              // Check to see if it matches or request
              if(match.equals(find)) {
                found = true;
                break;
              }
              pos++;
            }

            // Did we find something...
            if(found) {
              // Get the rectangle of the where the text would be visible...
              Rectangle viewRect = teamTextArea.modelToView(pos);
              // Scroll to make the rectangle visible
              teamTextArea.scrollRectToVisible(viewRect);
              // Highlight the text
              teamTextArea.setCaretPosition(pos + findLength);
              teamTextArea.moveCaretPosition(pos);
              // Move the search position beyond the current match
              pos += findLength;
            }

          }
          catch(Exception exp) {
            exp.printStackTrace();
          }

        }
      }
    });

    teamsFrame.setVisible(true);

    new Thread(new Runnable() {
      @Override
      public void run() {
        dbpfd = new DBPFD();

        Map<String, List<String>> reqPlayers = new HashMap<String, List<String>>();
        reqPlayers.put(Constants.PG, getReqPlayers(pg1ComboBox, pg2ComboBox));
        reqPlayers.put(Constants.SG, getReqPlayers(sg1ComboBox, sg2ComboBox));
        reqPlayers.put(Constants.SF, getReqPlayers(sf1ComboBox, sf2ComboBox));
        reqPlayers.put(Constants.PF, getReqPlayers(pf1ComboBox, pf2ComboBox));
        reqPlayers.put(Constants.C, getReqPlayers(cComboBox, null));

        dbpfd.createTeams(reqPlayers, excludedPlayerList.getSelectedValuesList(), new BigDecimal(minRatioField.getText()), new BigDecimal(
            minValueField.getText()), useTotalValueButton.isSelected() ? 'V' : useTotalCompButton.isSelected() ? 'C' : 'A', teamTextArea);
      }
    }).start();
  }

  @Override
  protected void updateProjectionsAndFillComboBoxes() {
    getGlassPane().activate("Updating Projections...");
    new Thread(new Runnable() {
      @Override
      public void run() {
        dbpfd = new DBPFD();
        final Map<String, List<Player>> playerMap = dbpfd.getPlayerMap(new BigDecimal(minRatioField.getText()), new BigDecimal(
            minValueField.getText()));

        if(!playerMap.isEmpty()) {
          EventQueue.invokeLater(new Runnable() {
            public void run() {
              try {
                addPlayersToComboBox(pg1ComboBox, pg2ComboBox, playerMap.get(Constants.PG));
                addPlayersToComboBox(sg1ComboBox, sg2ComboBox, playerMap.get(Constants.SG));
                addPlayersToComboBox(sf1ComboBox, sf2ComboBox, playerMap.get(Constants.SF));
                addPlayersToComboBox(pf1ComboBox, pf2ComboBox, playerMap.get(Constants.PF));
                addPlayersToComboBox(cComboBox, null, playerMap.get(Constants.C));
                addElementsToList(excludedPlayerList, playerMap.get(Constants.U));
                getGlassPane().deactivate();

                JTabbedPane tabbedPane = new JTabbedPane();
                tabbedPane.addTab(Constants.PG, getPositionTable(playerMap.get(Constants.PG)));
                tabbedPane.addTab(Constants.SG, getPositionTable(playerMap.get(Constants.SG)));
                tabbedPane.addTab(Constants.SF, getPositionTable(playerMap.get(Constants.SF)));
                tabbedPane.addTab(Constants.PF, getPositionTable(playerMap.get(Constants.PF)));
                tabbedPane.addTab(Constants.C, getPositionTable(playerMap.get(Constants.C)));

                JFrame playersFrame = new JFrame("Players");
                playersFrame.getContentPane().setLayout(new BorderLayout());
                playersFrame.setSize(640, 500);
                playersFrame.setLocationRelativeTo(getFrame());
                playersFrame.getContentPane().add(tabbedPane, BorderLayout.CENTER);
                // getGlassPane().deactivate();
                playersFrame.setVisible(true);
              }
              catch(Exception e) {
                e.printStackTrace();
              }
            }
          });
        }
        else {
          getGlassPane().deactivate();
          JOptionPane.showMessageDialog(frame, "An error occured while updating projections!", "Error", JOptionPane.ERROR_MESSAGE);
        }
      }
    }).start();
  }

}
